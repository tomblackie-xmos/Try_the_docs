<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" /><link rel="next" title="Image class" href="../../../AN00132_image_class/doc/rst/AN00132.html" /><link rel="prev" title="HID class" href="../../../AN00129_hid_class/doc/rst/AN00129.html" />

    <meta name="generator" content="sphinx-3.5.4, furo 2021.04.11.beta34"/>
        <title>CDC EDC class - Keith&#39;s Latest Docs 3.0.0 documentation</title>
      <link rel="stylesheet" href="../../../../_static/styles/furo.css?digest=59ab60ac09ea94ccfe6deddff6d715cce948a6fc">
    <link rel="stylesheet" href="../../../../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../../../../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css" />
    <link rel="stylesheet" href="../../../../_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">Keith's Latest Docs 3.0.0 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../../_static/xmos_logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Keith's Latest Docs 3.0.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../doc/rst/before_you_start.html">Before you start</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/version_info.html">Tool and Architecture Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_changelog.html">lib_xud Change Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_license.html">XMOS PUBLIC LICENCE: Version 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_copyrights.html">Copyright</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_contributions.html">How to contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/build_the_documentation_yourself.html">How to build the documenation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../lib_xud/doc/rst/the_xud_library.html">The XUD library</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/file_arrangement.html">File Arrangement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/resource_usage.html">Resource Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/basic_usage.html">Basic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/advanced_usage.html">Advanced Usage</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../../doc/usb_class_examples.html">USB Class examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../AN00124_CDC_VCOM_class/doc/rst/AN00124.html">CDC VCOM class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00125_mass_storage_class/doc/rst/AN00125.html">Mass Storage class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00126_printer_class/doc/rst/AN00126.html">Printer class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00127_video_class/doc/rst/AN00127.html">Video class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00129_hid_class/doc/rst/AN00129.html">HID class</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">CDC EDC class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00132_image_class/doc/rst/AN00132.html">Image class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00135_test_and_measurement_class/doc/rst/AN00135.html">Test and Measurement class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00136_vendor_specific/doc/rst/AN00136.html">Vendor Sepcific (Custom USB device)</a></li>
</ul>
</li>
</ul>

</div>
﻿

<select name="version" id="version-select" value="Latest" onchange="changeVersion(this.value)" >
    <option selected disabled>Other versions</option>
    <option value="html/latest/">Latest</option>
    <!-- <option value="html/v3/">3.0.0</option> -->
    <option value="html/v2/">2.0.0</option>
    <option value="html/v1/">1.0.0</option>
</select>




<script>
    function changeVersion(val) {
        var loc = window.location.toString();
        var i = loc.indexOf("html/");
        if (i >= 0) {
            var s1 = loc.substring(0, i);
            var i2 = loc.indexOf("/", i+6)
            var s2 = loc.substring(i2+1);
            nl=s1.concat(val, s2);


            var request = new XMLHttpRequest();  
            request.open('GET', nl, true);
            request.onreadystatechange = function(){
            if (request.readyState === 4){
                if (request.status === 404) {  
                    alert("Oh no, it does not exist!");
                    window.location.assign(loc);
                    location.reload();
                }
                else {
                    window.location.assign(nl);
                }  
            }
        };
        request.send();    
        }
    }
</script>



      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="cdc-edc-class">
<h1>CDC EDC class<a class="headerlink" href="#cdc-edc-class" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>USB Communications Class is a USB standard that defines mechanism for connecting
Networking devices to host machines. USB CDC has specified multiple Subclass standards to support different networking devices.
For Ethernet-style networking over USB, one of the following Subclass specifications is used:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Ethernet Control Model (ECM).</p></li>
<li><p>Ethernet Emulation Model (EEM).</p></li>
<li><p>Network Control Model (NCM).</p></li>
</ol>
</div></blockquote>
<p>Microsoft’s RNDIS is also a famous Ethernet over USB standard that is not only supported
in Windows but also in other OS platorms through thrid party drivers.</p>
<p>Ethernet over USB provides the following advantages:</p>
<blockquote>
<div><ul class="simple">
<li><p>Application independent exchange of data over USB.</p></li>
<li><p>Leverage the networking protocol stack present in operating systems.</p></li>
<li><p>Abstraction for USB application developers at network level like sockets, HTTP (web pages) etc.</p></li>
<li><p>USB-to-Ethernet Adaptors etc.</p></li>
</ul>
</div></blockquote>
<p>In this application note, the USB CDC-ECM class is chosen for the implementation of Ethernet
emulation of USB device and it is discussed in detail which will help you to develop your own
USB CDC-ECM product using xCORE-USB device or acts as a reference to implement other Ethernet
supporting subclass on xCORE-USB device.</p>
<p>The standard USB CDC-ECM class is specified in a document <strong>ECM 120.pdf</strong> which can be found in the USB-IF website.
(<a class="reference external" href="http://www.usb.org/developers/docs/devclass_docs/CDC1.2_WMC1.1_012011.zip">http://www.usb.org/developers/docs/devclass_docs/CDC1.2_WMC1.1_012011.zip</a>)</p>
</div>
<div class="section" id="block-diagram">
<h3>Block diagram<a class="headerlink" href="#block-diagram" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../../../../_images/block_diagram5.png"><img alt="../../../../_images/block_diagram5.png" src="../../../../_images/block_diagram5.png" style="width: 85%;"/></a>
<p class="caption"><span class="caption-number">Fig. 38 </span><span class="caption-text">Block diagram of USB CDC-ECM applications</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="usb-cdc-ecm-class-application-note">
<h2>USB CDC-ECM Class application note<a class="headerlink" href="#usb-cdc-ecm-class-application-note" title="Permalink to this headline">¶</a></h2>
<p>The example in this application note uses the XMOS USB device library and shows a simple program that enumerates a USB CDC-ECM Class device. The host side driver of this device will emulate an Ethernet interface that seamlessly connects with the network stack of host’s operating system. The USB device runs a very simple web server and acts like another device on Ethernet network i.e. the USB device imitates a network interface card of the host machine and a server connected to the host machine through Ethernet network.</p>
<p>For this USB CDC-ECM device application example, the system comprises four tasks running on separate logical cores of an xCORE-USB multicore microcontroller.</p>
<p>The tasks perform the following operations.</p>
<blockquote>
<div><ul class="simple">
<li><p>A task containing the USB library functionality to communicate over USB.</p></li>
<li><p>A task implementing Endpoint0 responding to both standard and CDC-ECM class-specific USB requests.</p></li>
<li><p>A task implementing the data endpoints and notification endpoint of the CDC-ECM class. It handles tx and rx buffers and provides APIs for applications to receive and transmit Ethernet frames.</p></li>
<li><p>A task containing Ethernet frame handler and simple HTTP server.</p></li>
</ul>
</div></blockquote>
<p>These tasks communicate via the use of xCONNECT channels which allow data to be
passed between application code running on separate logical cores. In this
example, XC interfaces are used, which abstracts out the channel communication
details with function level interface.</p>
<p>The following diagram shows the task and communication structure for this USB CDC-ECM
class application example.</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../../../../_images/task_diagram4.png"><img alt="../../../../_images/task_diagram4.png" src="../../../../_images/task_diagram4.png" style="width: 90%;"/></a>
<p class="caption"><span class="caption-number">Fig. 39 </span><span class="caption-text">Task diagram of the USB CDC-ECM example</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="makefile-additions-for-this-example">
<h3>Makefile additions for this example<a class="headerlink" href="#makefile-additions-for-this-example" title="Permalink to this headline">¶</a></h3>
<p>To start using the USB library, you need to add <strong>lib_usb</strong> to your makefile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USED_MODULES</span> <span class="o">=</span> <span class="o">...</span> <span class="n">lib_xud</span> <span class="o">...</span>
</pre></div>
</div>
<p>You can then access the USB functions in your source code via the <em>usb_device.h</em> header file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;usb_device.h&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="source-code-files">
<h3>Source code files<a class="headerlink" href="#source-code-files" title="Permalink to this headline">¶</a></h3>
<p>The example application consists of several source code files and the following list provides an overview of how the source code is organized.</p>
<blockquote>
<div><ul class="simple">
<li><p><em>xud_ecm.xc</em>, <em>xud_ecm.h</em> - Contains the USB CDC-ECM implementation which includes the USB
descriptors, endpoints handler tasks (functions), class-specific defines, xC interface to
read/write Ethernet frames.</p></li>
<li><p><em>main.xc</em> - Contains main() function and some USB defines.</p></li>
<li><p><em>packet_buffer.xc</em>, <em>queue.xc</em> - Buffer implementation to hold Ethernet frames (Max of
1514 bytes) and to allocate and deallocate dynamically from buffer pool. Queue
implementation to queue up the tx and rx frame buffers in a FIFO fashion.</p></li>
<li><p><em>ethernet.xc</em> - Contains implementation of application handling the Ethernet frames and
upper layer protocols like ICMP, DNS etc</p></li>
<li><p><em>eth_tcp</em> - This folder has TCP/IP and HTTP server implementation source files.
Note: This is not a complete TCP/IP stack.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="declaring-resource-and-setting-up-the-usb-components">
<h3>Declaring resource and setting up the USB components<a class="headerlink" href="#declaring-resource-and-setting-up-the-usb-components" title="Permalink to this headline">¶</a></h3>
<p><em>main.xc</em> has some defines in it that are used to configure the XMOS USB device library. These are displayed below.</p>
<p>The above set of defines describe the endpoints configuration for this device. This example
has bi-directional communication with the host machine via the standard endpoint0 and three other endpoints for implementing the part of our CDC-ECM class.</p>
<p>All these defines are passed to the setup function for the USB library which is called from <strong>main()</strong>.</p>
</div>
<div class="section" id="the-application-main-function">
<h3>The application main() function<a class="headerlink" href="#the-application-main-function" title="Permalink to this headline">¶</a></h3>
<p>Below is the source code for the main function of this application, which is taken from
the source file <code class="docutils literal notranslate"><span class="pre">main.xc</span></code></p>
<p>Looking at this in a more detail you can see the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>The par statement starts four separate tasks in parallel.</p></li>
<li><p>There is a task to configure and execute the USB library: <code class="docutils literal notranslate"><span class="pre">XUD_Main()</span></code>. This library
call runs in an infinite loop and handles all the underlying USB communications and provides abstraction at the endpoints level.</p></li>
<li><p>There is a task to startup and run the Endpoint0 code: <code class="docutils literal notranslate"><span class="pre">Endpoint0()</span></code>. It handles the
control endpoint zero and must be run in a separate logical core inorder to promptly respond to the control requests from host.</p></li>
<li><p>There is a task to handle all the other three endpoints required for the CDC-ECM class:
<code class="docutils literal notranslate"><span class="pre">CdcEcmEnpointsHandler()</span></code>. This function handles one bulk OUT and one bulk IN
endpoints for Ethernet frame transmissions and one interrupt IN endpoint for sending notifications to host.</p></li>
<li><p>There is a task to handle the Ethernet frames received from the host:
<code class="docutils literal notranslate"><span class="pre">EthernetFrameHandler()</span></code>. This task implements network stack and hosts the HTTP server. It also handles DNS queries, DHCP requests and ICMP pings.</p></li>
<li><p>The define USB_TILE describes the tile on which the individual tasks will run.</p></li>
<li><p>In this example all tasks run on the same tile as the USB PHY although this is only a
requirement of <code class="docutils literal notranslate"><span class="pre">XUD_Main()</span></code>.</p></li>
<li><p>The xCONNECT communication channels and the xC interface <em>cdc_ecm</em> used for inter-task
communication are setup at the beginning of <code class="docutils literal notranslate"><span class="pre">main()</span></code> and passed on to respective tasks.</p></li>
<li><p>The USB defines discussed earlier are passed into the function <code class="docutils literal notranslate"><span class="pre">XUD_Main()</span></code>.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="configuring-the-usb-device-id">
<h3>Configuring the USB Device ID<a class="headerlink" href="#configuring-the-usb-device-id" title="Permalink to this headline">¶</a></h3>
<p>The USB ID values used for vendor ID, product ID and device version number are defined in the file <code class="docutils literal notranslate"><span class="pre">xud_ecm.xc</span></code>. These are used by the host machine to determine the vendor of the device (in this case XMOS) and the product plus the firmware version.</p>
</div>
<div class="section" id="usb-descriptors">
<h3>USB Descriptors<a class="headerlink" href="#usb-descriptors" title="Permalink to this headline">¶</a></h3>
<p>USB CDC class device has to support class-specific descriptors apart from the
standard descriptors defined in the USB specifications. These class specific
descriptors are customized according to the need of the USB CDC device. In the
example application code, the descriptors implement the ECM model of the CDC
class to support Ethernet emulation at the host machine.</p>
<p>The following figure shows the descriptors used in the example code.</p>
<div class="figure align-default" id="id3">
<a class="reference internal image-reference" href="../../../../_images/usb_descriptors2.png"><img alt="../../../../_images/usb_descriptors2.png" src="../../../../_images/usb_descriptors2.png" style="width: 85%;"/></a>
<p class="caption"><span class="caption-number">Fig. 40 </span><span class="caption-text">USB descriptors hierarchical structure of CDC-ECM example</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="usb-device-descriptor">
<h4>USB Device Descriptor<a class="headerlink" href="#usb-device-descriptor" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">xud_ecm.xc</span></code> is where the standard USB device descriptor is declared for the CDC-ECM class device. Below is the structure which contains this descriptor. This will be requested by the host when the device is enumerated on the USB bus.</p>
<p>From this descriptor you can see that product, vendor and device firmware revision are all coded into this structure. This will allow the host machine to recognise the CDC device when it is connected to the USB bus.</p>
</div>
<div class="section" id="usb-configuration-descriptor">
<h4>USB Configuration Descriptor<a class="headerlink" href="#usb-configuration-descriptor" title="Permalink to this headline">¶</a></h4>
<p>The USB configuration descriptor is used to configure the device in terms of the device class and the endpoints setup. The hierarchy of descriptors under a configuration includes interfaces descriptors, class-specific descriptors and endpoints descriptors.</p>
<p>when a host requests a configuration descriptor, the entire configuration hierarchy including all the related descriptors are returned to the host. The following
code shows the configuration hierarchy of the demo application.</p>
<p>The configuration descriptor tells host about the power requirements of the device and the number of interfaces it supports.</p>
<p>The interface descriptors describe on how the host should communicate with the device in the class level. There are two interface descriptors in a USB CDC-ECM device.</p>
<p>The <strong>CDC Communication interface</strong> descriptor is for device management. You can see from the
code that the device uses Etherner Control Model as the interface subclass, this will make hosts to load default driver for CDC Ethernet. This interface has subordinate descriptors like
CDC functional descriptors and a notification endpoint descriptor. The class-specific
functional descriptors are discussed in detail in the next section. The notification endpoint
is an interrupt IN endpoint and is used to report device’s network connection state to the host. This endpoint is not used in this example application but will be employed when bridging an Ethernet interface to the USB-ECM device.</p>
<p>The <strong>CDC Data interface</strong> descriptor defines the interface for Ethernet frames transmission and reception between host and device. This interface has two endpoints, one bulk OUT endpoint for data transmissions from host to device and one bulk IN endpoint for data transmissions from device to host.</p>
<p>The above code from the endpoint descriptors shows that the maximum packet size of these endpoints to be 512 bytes (0x200) which is suited for handling Ethernet frames in less number of transactions.</p>
</div>
<div class="section" id="usb-cdc-ecm-functional-descriptors">
<h4>USB CDC-ECM Functional Descriptors<a class="headerlink" href="#usb-cdc-ecm-functional-descriptors" title="Permalink to this headline">¶</a></h4>
<p>Functional descriptors describe the content of class-specific information within the
Communication Class interface. The ‘USB_DESCTYPE_CS_INTERFACE’ define is used in the
descriptor structures to identify them. There are three functional descriptors used in this CDC-ECM example. They are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Header Functional Descriptor.</p></li>
<li><p>Union Functional Descriptor.</p></li>
<li><p>Ethernet Networking Functional Descriptor.</p></li>
</ol>
</div></blockquote>
<p>The Header and Union functional descriptors are generally used in all CDC subclasses and the Ethernet Networking functional descriptor is meant for the ECM subclass.</p>
<p>Header functional descriptor mentions the version of the CDC specification the interface comply with and it is shown below as found in the <em>cfgDesc[]</em> structure.</p>
<p>Note: The CDC version number (1.10) is mentioned as BCD in little endian format.</p>
<p>Union functional descriptor groups the interfaces that forms a CDC functional unit. It specifies one of the interfaces as master to handle control messages of the unit.
Following code from the CDC-ECM example shows that the the Communication Class interface 0 acts as master and the Data Class interface 1 acts as subordinate and together forming a single functional unit.</p>
<p>Ethernet networking functional descriptor provides the Ethernet related capabilities and parameters to the host. Following code shows the fields of the descriptor.</p>
<p>The above code shows the followings:</p>
<blockquote>
<div><ul class="simple">
<li><p>48-bit MAC address is provided through the string descriptor index, the string
descriptor will carry the MAC address in a Unicode string format (example: 00229708A003).</p></li>
<li><p>Ethernet statistics which the device collects. All bits are set to ‘0’ in this example
denoting that the device will not collect any Ethernet statistics.</p></li>
<li><p>Maximum segment size of 1514 bytes for handling 802.3 Ethernet frames.</p></li>
<li><p>Ethernet multicast filters and power filters are not supported in this USB-ECM example.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="usb-string-descriptors">
<h4>USB String Descriptors<a class="headerlink" href="#usb-string-descriptors" title="Permalink to this headline">¶</a></h4>
<p>String descriptors provide human readable information for your device and you can configure them with your USB product information. In CDC-ECM class it also provides the 48-bit MAC address of the device. The descriptors are placed in an array as shown in the below code.</p>
<p>The XMOS USB library will take care of encoding the strings into Unicode and structures the content into USB string descriptor format.</p>
</div>
</div>
<div class="section" id="usb-standard-and-class-specific-requests">
<h3>USB Standard and Class-Specific requests<a class="headerlink" href="#usb-standard-and-class-specific-requests" title="Permalink to this headline">¶</a></h3>
<p>In <em>xud_ecm.xc</em> there is a function <em>Endpoint0()</em> which handles all the USB control requests sent by host to control endpoint 0. USB control requests includes both standard USB requests and the CDC-ECM class-specific requests.</p>
<p>In <em>Endpoint0()</em> function, a USB request is received as a setup packet by calling <em>USB_GetSetupPacket()</em> library function. The setup packet structure is then examined to distinguish between standard and class-specific requests.</p>
<p>The XMOS USB library provides a function <em>USB_StandardRequests()</em> to handle all the standard USB requests. This function is called with setup packet and descriptors structures as shown below</p>
<p>The CDC Communication interface uses endpoint 0 as management element and receives class-specific control requests on it. The following code shows how the ECM class-specific requests are filtered and passed to a function <em>ControlInterfaceClassRequests()</em> for further handling.</p>
<p>The <em>ControlInterfaceClassRequests()</em> function is the place to handle all CDC-ECM requests, These requests are defined in the <em>xud_ecm.xc</em> as follows:</p>
<p>According to ECM specification, except <em>SET_ETHERNET_PACKET_FILTER</em> all the other requests are
optional. These requests are not used in this example application but will be used when
bridging an Ethernet interface to the USB device. In case of bridging an Ethernet interface,
the Ethernet MAC software layer and PHY software layer will be employed and the MAC API
functions can be directly used to perform the actions requested by the class-specific requests.</p>
</div>
<div class="section" id="ethernet-frame-handling">
<h3>Ethernet frame handling<a class="headerlink" href="#ethernet-frame-handling" title="Permalink to this headline">¶</a></h3>
<p>The Data Class interface containing the bulk endpoints is used for exchanging Ethernet frames between the device and host. The Ethernet frame includes everything starting from the destination MAC address to the end of the data field, but excludes the CRC. This frame structure is shown below:</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="../../../../_images/ethernet_frame.png"><img alt="../../../../_images/ethernet_frame.png" src="../../../../_images/ethernet_frame.png" style="width: 100%;"/></a>
<p class="caption"><span class="caption-number">Fig. 41 </span><span class="caption-text">Ethernet frame exchanged over the USB endpoints</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>To handle asynchronous communication over two endpoints, events are used by means of select statements as shown in the following piece of code from <em>CdcEcmEndpointsHandler()</em> task.</p>
<p>When OUT endpoint receives data, an event is triggered and the <em>XUD_GetData_Select()</em> case is executed. Similary, when IN endpoint completes sending data to host the <em>XUD_SetData_Select()</em> case is executed.</p>
<p>The maximum size of an Ethernet frame (1514 bytes) is greater than the maximum packet size (512 bytes) of the USB endpoints, therefore an Ethernet frame may be split into multiple USB packet transfers. A USB short packet notifies the end of an Ethernet frame, if the frame size is exactly a multiple of the maximum packet size of USB then a zero length packet is used to notify the end of frame.</p>
<p>You can see from the above code that a free buffer is allocated using <em>packetBufferAlloc()</em>, which is used to receive an Ethernet frame. Once the frame is completely received the <em>qPut()</em> function is used to add the frame into a queue. The <em>QUEUE_LENGTH</em> (four) defined in <em>queue.h</em> determines the maximum number of ethernet frames buffered up in the queue.</p>
<p>There is also a separate queue to handle the Ethernet frames that are transmitted to the host from the device.</p>
</div>
<div class="section" id="application-interface">
<h3>Application interface<a class="headerlink" href="#application-interface" title="Permalink to this headline">¶</a></h3>
<p>The application interface is the set of functions defined as xC interface that enables application tasks to send/receive Ethernet frames over the ECM data endpoints. The API functions abstracts out all the buffering implementation details done at the endpoint level.
This xC interface is declared in <em>xud_ecm.h</em> file as shown below.</p>
<p>In the above code, the <em>read_frame()</em> function gets an Ethernet frame which is waiting in the reception queue, Similarly, the <em>write_frame()</em> function adds the Ethernet frame to the transmission queue.</p>
<p>These interface functions pass arguments and return values over xCONNECT channels and provide well defined inter-task communication. The server side of these functions are defined under select case statements in the <em>CdcEcmEndpointsHandler()</em> task.</p>
</div>
<div class="section" id="demo-application">
<h3>Demo application<a class="headerlink" href="#demo-application" title="Permalink to this headline">¶</a></h3>
<p>In this USB CDC-ECM example, the Ethernet frames received from the host are handled by the <em>EthernetFrameHandler()</em> task. This application task runs a simple HTTP server acting as a virtual network device. This task performs the following:</p>
<blockquote>
<div><ul>
<li><p>Handles DHCP requests from the host PC to provide an IP address to it. The IP addresses are
defined in the <em>ethernet.xc</em> file as shown below</p>
<blockquote>
<div><p>The client IP address corresponds to the host PC and the server IP address belongs to the USB device.</p>
</div></blockquote>
</li>
<li><p>Handles DNS queries containing the server name defined in the <em>ethernet.xc</em> file. The
server name is as shown below.</p>
<blockquote>
<div><p>The <em>localname[]</em> is initialized in DNS name format and it corresponds to “xmos-cdc.local”</p>
</div></blockquote>
</li>
<li><p>Handles HTTP webpage requests and ICMP control ping requests.</p></li>
<li><p>Collects a statistics of the different packets received from the host PC and embeds the
information in the web page.</p></li>
</ul>
</div></blockquote>
<p><a href="#id10"><span class="problematic" id="id11">|appendix|</span></a></p>
</div>
</div>
<div class="section" id="demo-hardware-setup">
<h2>Demo Hardware Setup<a class="headerlink" href="#demo-hardware-setup" title="Permalink to this headline">¶</a></h2>
<p>To setup the demo hardware the following boards are required.</p>
<blockquote>
<div><ul>
<li><p>xCORE-USB sliceKIT (XK-SK-U16-ST)</p>
<blockquote>
<div><ul class="simple">
<li><p>xCORE-USB Core board.</p></li>
<li><p>USB A/B sliceCARD.</p></li>
<li><p>xTAG-2 debug adaptor</p></li>
<li><p>Power supply</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="../../../../_images/usb-slicekit5.png"><img alt="../../../../_images/usb-slicekit5.png" src="../../../../_images/usb-slicekit5.png" style="width: 110%;"/></a>
<p class="caption"><span class="caption-number">Fig. 42 </span><span class="caption-text">XMOS xCORE-USB sliceKIT</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<p>The hardware should be configured as displayed above for this demo:</p>
<blockquote>
<div><ul class="simple">
<li><p>The XTAG debug adapter should be connected to the XSYS connector and
the XTAG USB should be connected to the host machine.</p></li>
<li><p>The USB sliceCARD should be connected to the U slot (J4 header) of the xCORE-USB Core
board and the other end of USB sliceCARD should be connected to host machine using a USB
cable.</p></li>
<li><p>The XLINK switch on the core board should be set on ON position.</p></li>
<li><p>The xCORE-USB core board should have the power cable connected.</p></li>
</ul>
</div></blockquote>
<p>Note: The XLINK switch is set to ON position to enable xSCOPE to function. The use of xSCOPE
is required in this application so that the print messages that are generated on the device as
part of the demo do not interfere with the real-time behavior of the USB device.</p>
</div>
<div class="section" id="launching-the-demo-application">
<h2>Launching the demo application<a class="headerlink" href="#launching-the-demo-application" title="Permalink to this headline">¶</a></h2>
<p>Once the demo example has been built either from the command line using
xmake or via the build mechanism of xTIMEcomposer studio we can execute
the application on the xCORE-USB sliceKIT.</p>
<p>Once built there will be a <em>bin</em> directory within the project which
contains the binary for the xCORE device. The xCORE binary has a XMOS standard
.xe extension.</p>
<div class="section" id="launching-from-the-command-line">
<h3>Launching from the command line<a class="headerlink" href="#launching-from-the-command-line" title="Permalink to this headline">¶</a></h3>
<p>From the command line the <code class="docutils literal notranslate"><span class="pre">xrun</span></code> tool is used to download code to both the
xCORE devices. Changing into the bin directory of the project
we can execute the code on the xCORE microcontroller as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">xrun</span> <span class="o">--</span><span class="n">xscope</span> <span class="n">app_usb_ecm</span><span class="o">.</span><span class="n">xe</span>          <span class="o">&lt;--</span> <span class="n">Download</span> <span class="ow">and</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">xCORE</span> <span class="n">code</span>
</pre></div>
</div>
<p>Once this command has executed the CDC Ethernet device should have
enumerated on your machine and you will see the following text in the console window:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">XMOS</span> <span class="n">USB</span> <span class="n">CDC</span><span class="o">-</span><span class="n">ECM</span> <span class="n">Class</span> <span class="n">demo</span><span class="o">--</span>

<span class="n">Server</span> <span class="n">IP</span> <span class="n">Address</span><span class="p">:</span> <span class="mf">169.254.85.85</span>
<span class="n">Server</span> <span class="n">URL</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">xmos</span><span class="o">-</span><span class="n">cdc</span><span class="o">.</span><span class="n">local</span>
</pre></div>
</div>
</div>
<div class="section" id="launching-from-xtimecomposer-studio">
<h3>Launching from xTIMEcomposer Studio<a class="headerlink" href="#launching-from-xtimecomposer-studio" title="Permalink to this headline">¶</a></h3>
<p>From xTIMEcomposer Studio the run mechanism is used to download code to
xCORE device. Select the xCORE binary from the bin directory, right click
and then follow the instructions below.</p>
<ul>
<li><p>Select <strong>Run As</strong>.</p></li>
<li><p>Select <strong>Run Configurations</strong>.</p></li>
<li><p>Double click on xCORE application**.</p></li>
<li><p>Enable xSCOPE in Target I/O options:</p>
<div class="figure align-default" id="id6">
<img alt="../../../../_images/xtime-run-xscope2.png" src="../../../../_images/xtime-run-xscope2.png"/>
<p class="caption"><span class="caption-number">Fig. 43 </span><span class="caption-text">xTIMEcomposer xSCOPE configuration</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
</li>
<li><p>Click <strong>Apply</strong> and then <strong>Run</strong>.</p></li>
</ul>
<p>Once the application is launched the CDC Ethernet device should have
enumerated on your machine and you will see the following text in the console window:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">XMOS</span> <span class="n">USB</span> <span class="n">CDC</span><span class="o">-</span><span class="n">ECM</span> <span class="n">Class</span> <span class="n">demo</span><span class="o">--</span>

<span class="n">Server</span> <span class="n">IP</span> <span class="n">Address</span><span class="p">:</span> <span class="mf">169.254.85.85</span>
<span class="n">Server</span> <span class="n">URL</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">xmos</span><span class="o">-</span><span class="n">cdc</span><span class="o">.</span><span class="n">local</span>
</pre></div>
</div>
</div>
<div class="section" id="running-the-demo">
<h3>Running the demo<a class="headerlink" href="#running-the-demo" title="Permalink to this headline">¶</a></h3>
<p>This demo works right away on platforms that have native support for USB CDC-ECM class.
Most of the Linux OS have native support for this CDC Ethernet. The demo application is tested on Ubuntu 12.04LTS version.</p>
<div class="section" id="running-on-linux">
<h4>Running on Linux<a class="headerlink" href="#running-on-linux" title="Permalink to this headline">¶</a></h4>
<p>Once the USB device is enumerated in the host machine, the default CDC Ethernet driver will be loaded. This host driver emulates the virtual Ethernet interface.</p>
<blockquote>
<div><ul class="simple">
<li><p>Run the command <em>ifconfig</em> in a terminal to view the emulated Ethernet interface as shown
in the following figure.</p></li>
</ul>
<div class="figure align-default" id="id7">
<a class="reference internal image-reference" href="../../../../_images/linux_cdc_ethernet.png"><img alt="../../../../_images/linux_cdc_ethernet.png" src="../../../../_images/linux_cdc_ethernet.png" style="width: 70%;"/></a>
<p class="caption"><span class="caption-number">Fig. 44 </span><span class="caption-text">Emulated Ethernet interface in the host PC</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
<ul>
<li><p>Run <em>ping 169.254.85.85</em> command to ping the server running in the USB device. This ping
command sends ICMP request packets to the server and it is shown in the following figure</p>
<div class="figure align-default" id="id8">
<a class="reference internal image-reference" href="../../../../_images/linux_demo_ping.png"><img alt="../../../../_images/linux_demo_ping.png" src="../../../../_images/linux_demo_ping.png" style="width: 70%;"/></a>
<p class="caption"><span class="caption-number">Fig. 45 </span><span class="caption-text">Pinging server from host PC</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</div>
</li>
<li><p>Open the URL <em>http://xmos-cdc.local</em> in a standard web browser like Mozilla or Chrome to
see the web page hosted by the USB device. The web page provides a statistics of the packets handled by the USB device and it is shown below:</p>
<div class="figure align-default" id="id9">
<a class="reference internal image-reference" href="../../../../_images/linux_demo_webpage.png"><img alt="../../../../_images/linux_demo_webpage.png" src="../../../../_images/linux_demo_webpage.png" style="width: 80%;"/></a>
<p class="caption"><span class="caption-number">Fig. 46 </span><span class="caption-text">Webpage hosted by USB CDC-ECM device</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
</li>
<li><p>Refresh the opened webpage to see the packets count updated. Also note the number of ICMP
packets is same as the number of ping requests sent out previously.</p></li>
</ul>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="full-source-code-listing">
<h2>Full source code listing<a class="headerlink" href="#full-source-code-listing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="source-code-for-main-xc">
<h3>Source code for main.xc<a class="headerlink" href="#source-code-for-main-xc" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="source-code-for-xud-ecm-xc">
<h3>Source code for xud_ecm.xc<a class="headerlink" href="#source-code-for-xud-ecm-xc" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../../AN00132_image_class/doc/rst/AN00132.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Image class</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../../../AN00129_hid_class/doc/rst/AN00129.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">HID class</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, XMOS Ltd
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../../../../_sources/examples/AN00131_CDC_EDC_class/doc/rst/AN00131.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">CDC EDC class</a><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#block-diagram">Block diagram</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usb-cdc-ecm-class-application-note">USB CDC-ECM Class application note</a><ul>
<li><a class="reference internal" href="#makefile-additions-for-this-example">Makefile additions for this example</a></li>
<li><a class="reference internal" href="#source-code-files">Source code files</a></li>
<li><a class="reference internal" href="#declaring-resource-and-setting-up-the-usb-components">Declaring resource and setting up the USB components</a></li>
<li><a class="reference internal" href="#the-application-main-function">The application main() function</a></li>
<li><a class="reference internal" href="#configuring-the-usb-device-id">Configuring the USB Device ID</a></li>
<li><a class="reference internal" href="#usb-descriptors">USB Descriptors</a><ul>
<li><a class="reference internal" href="#usb-device-descriptor">USB Device Descriptor</a></li>
<li><a class="reference internal" href="#usb-configuration-descriptor">USB Configuration Descriptor</a></li>
<li><a class="reference internal" href="#usb-cdc-ecm-functional-descriptors">USB CDC-ECM Functional Descriptors</a></li>
<li><a class="reference internal" href="#usb-string-descriptors">USB String Descriptors</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usb-standard-and-class-specific-requests">USB Standard and Class-Specific requests</a></li>
<li><a class="reference internal" href="#ethernet-frame-handling">Ethernet frame handling</a></li>
<li><a class="reference internal" href="#application-interface">Application interface</a></li>
<li><a class="reference internal" href="#demo-application">Demo application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#demo-hardware-setup">Demo Hardware Setup</a></li>
<li><a class="reference internal" href="#launching-the-demo-application">Launching the demo application</a><ul>
<li><a class="reference internal" href="#launching-from-the-command-line">Launching from the command line</a></li>
<li><a class="reference internal" href="#launching-from-xtimecomposer-studio">Launching from xTIMEcomposer Studio</a></li>
<li><a class="reference internal" href="#running-the-demo">Running the demo</a><ul>
<li><a class="reference internal" href="#running-on-linux">Running on Linux</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#full-source-code-listing">Full source code listing</a><ul>
<li><a class="reference internal" href="#source-code-for-main-xc">Source code for main.xc</a></li>
<li><a class="reference internal" href="#source-code-for-xud-ecm-xc">Source code for xud_ecm.xc</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/tabs.js"></script>
    <script src="../../../../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>