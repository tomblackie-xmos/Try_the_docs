<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" /><link rel="next" title="Mass Storage class" href="../../../AN00125_mass_storage_class/doc/rst/AN00125.html" /><link rel="prev" title="USB Class examples" href="../../../doc/usb_class_examples.html" />

    <meta name="generator" content="sphinx-3.5.4, furo 2021.04.11.beta34"/>
        <title>CDC VCOM class - Keith&#39;s Original Docs 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../../../_static/styles/furo.css?digest=59ab60ac09ea94ccfe6deddff6d715cce948a6fc">
    <link rel="stylesheet" href="../../../../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../../../../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css" />
    <link rel="stylesheet" href="../../../../_static/styles/furo-extensions.css?digest=d391b54134226e4196576da3bdb6dddb7e05ba2b"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">Keith's Original Docs 1.0.0 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../../_static/xmos_logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Keith's Original Docs 1.0.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../doc/rst/before_you_start.html">Before you start</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/version_info.html">Tool and Architecture Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_changelog.html">lib_xud Change Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_license.html">XMOS PUBLIC LICENCE: Version 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_copyrights.html">Copyright</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/inc_contributions.html">How to contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../doc/rst/build_the_documentation_yourself.html">How to build the documenation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../lib_xud/doc/rst/the_xud_library.html">The XUD library</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/file_arrangement.html">File Arrangement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/resource_usage.html">Resource Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/basic_usage.html">Basic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../lib_xud/doc/rst/advanced_usage.html">Advanced Usage</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../../../doc/usb_class_examples.html">USB Class examples</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">CDC VCOM class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00125_mass_storage_class/doc/rst/AN00125.html">Mass Storage class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00126_printer_class/doc/rst/AN00126.html">Printer class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00127_video_class/doc/rst/AN00127.html">Video class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00129_hid_class/doc/rst/AN00129.html">HID class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00131_CDC_EDC_class/doc/rst/AN00131.html">CDC EDC class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00132_image_class/doc/rst/AN00132.html">Image class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00135_test_and_measurement_class/doc/rst/AN00135.html">Test and Measurement class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../AN00136_vendor_specific/doc/rst/AN00136.html">Vendor Sepcific (Custom USB device)</a></li>
</ul>
</li>
</ul>

</div>
﻿<select name="version" id="version-select" value="latest" onchange="location = this.value;">
    <option selected disabled>Older versions</option>
    <option value="../latest/index.html">Latest</option>
    <!--<option value="../v2/index.html">2.0.0</option>-->
    <!--<option value="../v1/index.html">1.0.0</option>-->
</select>



      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="cdc-vcom-class">
<h1>CDC VCOM class<a class="headerlink" href="#cdc-vcom-class" title="Permalink to this headline">¶</a></h1>
<p>USB Communication Class is a composite USB device class that enables telecommunication devices
like digital telephones, ISDN terminal adapters, etc and networking devices like ADSL
modems, Ethernet adapters/hubs, etc to connect to a USB host machine. It specifies
multiple models to support different types of communication devices. Abstract
Control Model (ACM) is defined to support legacy modem devices and an advantage
of ACM is the Serial emulation feature. Serial emulation of a USB device eases the development of
host PC application, provides software compatibility with RS-232 based legacy devices, enables USB to RS-232 conversions and gives good abstraction over the USB for application developers.</p>
<p>In this application note, the USB CDC implementation on xCORE-USB device is explained in detail which will help you in two ways. First, it acts as reference for you to build your own USB CDC class device, second, it gives you
an idea of how to use this virtual serial port code in your application.</p>
<p>The standard USB CDC class specification can be found in the USB-IF website.</p>
<p>(<a class="reference external" href="http://www.usb.org/developers/docs/devclass_docs/CDC1.2_WMC1.1_012011.zip">http://www.usb.org/developers/docs/devclass_docs/CDC1.2_WMC1.1_012011.zip</a>)</p>
<div class="section" id="block-diagram">
<h2>Block diagram<a class="headerlink" href="#block-diagram" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../../../../_images/block_diagram.png"><img alt="../../../../_images/block_diagram.png" src="../../../../_images/block_diagram.png" style="width: 100%;"/></a>
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">Block diagram of USB CDC applications</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="usb-cdc-class-application-note">
<h3>USB CDC Class application note<a class="headerlink" href="#usb-cdc-class-application-note" title="Permalink to this headline">¶</a></h3>
<p>The example in this application note uses the XMOS USB device library and shows a simple program that enumerates a USB CDC Class device as virtual serial port in a host machine and provides a simple character loopback device.</p>
<p>For this USB CDC device application example, the system comprises four tasks running on separate logical cores of an xCORE-USB multicore microcontroller.</p>
<p>The tasks perform the following operations.</p>
<blockquote>
<div><ul class="simple">
<li><p>A task containing the USB library functionality to communicate over USB.</p></li>
<li><p>A task implementing Endpoint0 responding to both standard and CDC class-specific USB requests.</p></li>
<li><p>A task implementing the data endpoints and notification endpoint of the CDC ACM class. It handles tx and rx buffers and provides interface for applications.</p></li>
<li><p>A task implementing the application logic to interact with user over the virtual serial port.</p></li>
</ul>
</div></blockquote>
<p>These tasks communicate via the use of xCONNECT channels which allow data to be
passed between application code running on separate logical cores. In this
example, XC interfaces are used, which abstracts out the channel communication
details with function level interface.</p>
<p>The following diagram shows the task and communication structure for this USB CDC
class application example.</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../../../../_images/task_diagram.png"><img alt="../../../../_images/task_diagram.png" src="../../../../_images/task_diagram.png" style="width: 100%;"/></a>
<p class="caption"><span class="caption-number">Fig. 3 </span><span class="caption-text">Task diagram of the USB CDC Virtual Serial Port example</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="makefile-additions-for-this-example">
<h2>Makefile additions for this example<a class="headerlink" href="#makefile-additions-for-this-example" title="Permalink to this headline">¶</a></h2>
<p>To start using the USB library, you need to add <strong>lib_xud</strong> to your makefile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USED_MODULES</span> <span class="o">=</span> <span class="o">...</span> <span class="n">lib_xud</span> <span class="o">...</span>
</pre></div>
</div>
<p>You can then access the USB functions in your source code via the <em>usb_device.h</em> header file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;usb_device.h&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="source-code-files">
<h2>Source code files<a class="headerlink" href="#source-code-files" title="Permalink to this headline">¶</a></h2>
<p>The example application consists of the following files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main</span><span class="o">.</span><span class="n">xc</span>
<span class="n">xud_cdc</span><span class="o">.</span><span class="n">xc</span>
<span class="n">xud_cdc</span><span class="o">.</span><span class="n">h</span>
</pre></div>
</div>
<p><em>xud_cdc.xc</em> contains the CDC ACM implementation which includes the USB descriptors, endpoints handler functions and the xC interface (APIs) for application programs.
The <em>xud_cdc.h</em> header is included in the <em>main.xc</em> to use the APIs exposed
by <em>xud_cdc.xc</em>. The <em>main.xc</em> implements the application logic that interacts over the USB CDC link with a host terminal application.</p>
</div>
<div class="section" id="declaring-resource-and-setting-up-the-usb-components">
<h2>Declaring resource and setting up the USB components<a class="headerlink" href="#declaring-resource-and-setting-up-the-usb-components" title="Permalink to this headline">¶</a></h2>
<p><em>main.xc</em> contains the application implementation for a device based on the USB CDC device class. There are some defines in it that are used to configure the XMOS USB device library. These are displayed below.</p>
<p>These defines describe the endpoints configuration for this device. This example
has bi-directional communication with the host machine via the standard endpoint0 and three
other endpoints for implementing the part of our CDC class device.</p>
<p>These defines are passed to the setup function for the USB library which is called from <code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p>
</div>
<div class="section" id="the-application-main-function">
<h2>The application main() function<a class="headerlink" href="#the-application-main-function" title="Permalink to this headline">¶</a></h2>
<p>Below is the source code for the main function of this application, which is taken from
the source file <code class="docutils literal notranslate"><span class="pre">main.xc</span></code></p>
<p>Looking at this in a more detail you can see the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>The par statement starts four separate tasks in parallel.</p></li>
<li><p>There is a task to configure and execute the USB library: <code class="docutils literal notranslate"><span class="pre">XUD_Main()</span></code>. This library
call runs in an infinite loop and handles all the underlying USB communications and provides abstraction at the endpoints level.</p></li>
<li><p>There is a task to startup and run the Endpoint0 code: <code class="docutils literal notranslate"><span class="pre">Endpoint0()</span></code>. It handles the
control endpoint zero and must be run in a separate logical core inorder to promptly respond to the control requests from host.</p></li>
<li><p>There is a task to handle all the other three endpoints required for the CDC class:
<code class="docutils literal notranslate"><span class="pre">CdcEnpointsHandler()</span></code>. This function handles one bulk OUT and one bulk IN
endpoints for data transmissions and one interrupt IN endpoint for sending notifications
to host.</p></li>
<li><p>There is a task to run the application logic that interacts with user over the
virtual serial port: <code class="docutils literal notranslate"><span class="pre">app_virtual_com()</span></code>.</p></li>
<li><p>The define USB_TILE describes the tile on which the individual tasks will run.</p></li>
<li><p>The xCONNECT communication channels and the xC interface <em>cdc_data</em> used for inter task
communication are setup at the beginning of <code class="docutils literal notranslate"><span class="pre">main()</span></code> and passed on to respective tasks.</p></li>
<li><p>The USB defines discussed earlier are passed into the function <code class="docutils literal notranslate"><span class="pre">XUD_Main()</span></code>.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="configuring-the-usb-device-id">
<h2>Configuring the USB Device ID<a class="headerlink" href="#configuring-the-usb-device-id" title="Permalink to this headline">¶</a></h2>
<p>The USB ID values used for vendor ID, product ID and device version number are defined in the file <code class="docutils literal notranslate"><span class="pre">xud_cdc.xc</span></code>. These are used by the host machine to determine the vendor of the device (in this case XMOS) and the product plus the firmware version.</p>
</div>
<div class="section" id="usb-descriptors">
<h2>USB Descriptors<a class="headerlink" href="#usb-descriptors" title="Permalink to this headline">¶</a></h2>
<p>USB CDC class device has to support class-specific descriptors apart from the
standard descriptors defined in the USB specifications. These class specific
descriptors are customized according to the need of the USB CDC device. In the
example application code, the descriptors implement the ACM model of the CDC
class and are customized to suit a virtual serial port.</p>
<p>The following figure shows the descriptors used in the example code.</p>
<div class="figure align-default" id="id3">
<a class="reference internal image-reference" href="../../../../_images/usb_descriptors.png"><img alt="../../../../_images/usb_descriptors.png" src="../../../../_images/usb_descriptors.png" style="width: 85%;"/></a>
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">USB descriptors hierarchical structure of CDC example</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">xud_cdc.xc</span></code> is where the standard USB device descriptor is declared for the CDC class device. Below is the structure which contains this descriptor. This will be requested by the host when the device is enumerated on the USB bus.</p>
<p>From this descriptor you can see that product, vendor and device firmware revision are all coded into this structure. This will allow the host machine to recognise the CDC device when it is connected to the USB bus.</p>
<p>The USB configuration descriptor is used to configure the device in terms of the device class and the endpoints setup. The hierarchy of descriptors under a configuration includes interfaces descriptors, class-specific descriptors and endpoints descriptors.</p>
<p>when a host requests a configuration descriptor, the entire configuration hierarchy including all the related descriptors are returned to the host. The following
code shows the configuration hierarchy of the demo application.</p>
<p>The configuration descriptor tells host about the power requirements of the device and the number of interfaces it supports.</p>
<p>The interface descriptors describe on how the host should communicate with the device in the class level. There are two interface descriptors in a USB CDC device.</p>
<p>The <strong>CDC Communication interface</strong> descriptor is for device management. You can see from the
code that the device uses Abstract Control Model and supports AT Command V.25ter protocol.
Though this example device doesn’t support AT V.25ter protocol, it is mentioned to make the
device compatible with standard host drivers. This interface has subordinate descriptors like
CDC functional descriptors and a notification endpoint descriptor. The class-specific
functional descriptors are discussed in detail in the next section. The notification endpoint
is an interrupt IN endpoint and is used to report device’s serial state to the host. This
endpoint is not used in this example application but will be employed when bridging a UART to
the USB Virtual COM port.</p>
<p>The <strong>CDC Data interface</strong> descriptor defines the interface for data transmission and reception between host and device. This interface has two endpoints, one bulk OUT endpoint for data transmissions from host to device and one bulk IN endpoint for data transmissions from device to host.</p>
<p>The above code from the endpoint descriptors shows that the maximum packet size of these endpoints to be 512 bytes (0x200) which is suited for applications requiring high data throughput.</p>
<p>Functional descriptors describe the content of class-specific information within the Communication Class interface. The ‘USB_DESCTYPE_CS_INTERFACE’ define is used in the descriptor structures to identify them. There are four functional descriptors used in this CDC example. They are:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Header functional descriptor.</p></li>
<li><p>ACM functional descriptor.</p></li>
<li><p>Union functional descriptor.</p></li>
<li><p>Call management functional descriptor.</p></li>
</ol>
</div></blockquote>
<p>Header functional descriptor mentions the version of the CDC specification the interface compiles with and it is shown below as found in the <em>cfgDesc[]</em> structure.</p>
<p>Note: The CDC version number (1.10) is mentioned as BCD in little endian format.</p>
<p>ACM functional descriptor tells the class-specific commands and notifications supported by the CDC device. The application code supports a subset of commands corresponding to ACM subclass and thus the bit D1 is set to 1 in <em>bmCapabilities</em> field of the descriptor as shown below</p>
<p>Union functional descriptor groups the interfaces that forms a CDC functional unit. It specifies one of the interfaces as master to handle control messages of the unit. In the CDC example, the Communication Class interface acts as master and the Data Class interface acts as subordinate and together forming a single functional unit.</p>
<p>Call management functional descriptor decides on how the device manages calls. The bit fields D0 and D1 of <em>bmCapabilities</em> are set to one in the descriptor to tell host driver that the device handles call management by itself and it could even use Data class interface for that purpose. The below code shows that configuration.</p>
<p>String descriptors provide human readable information for your device and you can configure them with your USB product information. The descriptors are placed in an array as shown in the below code.</p>
<p>The XMOS USB library will take care of encoding the strings into Unicode and structures the content into USB string descriptor format.</p>
</div>
<div class="section" id="usb-standard-and-class-specific-requests">
<h2>USB Standard and Class-Specific requests<a class="headerlink" href="#usb-standard-and-class-specific-requests" title="Permalink to this headline">¶</a></h2>
<p>In <em>xud_cdc.xc</em> there is a function <em>Endpoint0()</em> which handles all the USB control requests sent by host to control endpoint 0. USB control requests includes both standard USB requests and the CDC class-specific requests.</p>
<p>In <em>Endpoint0()</em> function, a USB request is received as a setup packet by calling <em>USB_GetSetupPacket()</em> library function. The setup packet structure is then examined to distinguish between standard and class-specific requests.</p>
<p>The XMOS USB library provides a function <em>USB_StandardRequests()</em> to handle the standard USB requests. This function is called with setup packet and descriptors structures as shown below</p>
<p>The CDC Communication interface uses endpoint 0 as management element and receives class-specific control requests on it. The following code shows how the class-specific requests are filtered and passed to a function <em>ControlInterfaceClassRequests()</em> for further handling.</p>
<p>The <em>ControlInterfaceClassRequests()</em> function handles a subset of CDC ACM requests which are defined in the <em>xud_cdc.xc</em> as follows:</p>
<p>In virtual serial port, the above commands are used to set and get serial port parameters like baud rate, parity, stop bits etc and also to emulate hardware flow control using DTR (Data Terminal Ready) and RTS (Request To Send) signals.</p>
<p>You can use the functions <em>ControlInterfaceClassRequests()</em> and the <em>Endpoint0()</em> as reference to handle more commands of the subclass or you can even implement a different model/subclass for your USB CDC device.</p>
</div>
<div class="section" id="data-handling">
<h2>Data handling<a class="headerlink" href="#data-handling" title="Permalink to this headline">¶</a></h2>
<p>The two bulk data endpoints of the CDC Data interface are handled by the task <em>CdcEndpointsHandler()</em> present in <em>xud_cdc.xc</em>. As there is no subprotocol used, the bytes received through these endpoints represent the raw data sent from a host terminal software. This data is handled using a double buffer mechanism and hence increases the performance of the device.</p>
<p>To handle asynchronous communication over two endpoints, events are used by means of select statements as shown in the following piece of code from <em>CdcEndpointsHandler()</em> task.</p>
<p>When OUT endpoint receives data, an event is triggered and the <em>XUD_GetData_Select()</em> case is executed. Similary, when IN endpoint completes sending data to host the <em>XUD_SetData_Select()</em> case is executed. This event driven approach not only handles multiple endpoints but also provides way to include other events and build more logic into the task.</p>
</div>
<div class="section" id="application-interface">
<h2>Application interface<a class="headerlink" href="#application-interface" title="Permalink to this headline">¶</a></h2>
<p>The application interface is the set of functions defined as xC interface that enables
application tasks to send/receive data over the USB CDC endpoints. This API funtions abstract
out all the buffering implementation details done at the endpoint level for data
communications. This xC interface is declared in <em>xud_cdc.h</em> file and it is shown below.</p>
<p>These interface functions pass arguments and return values over xCONNECT channels and provides well defined inter-task communication. The server side of these functions are defined under select case statements in the <em>CdcEndpointsHandler()</em> task.</p>
<p>In the example code, main.xc has the <em>app_virtual_com()</em> function which uses this interface to implement a simple loopback to interact with user.
The following code is taken from <em>app_virtual_com()</em> function</p>
<p>In the above code you can observe that the interface’s functions are accessed via a variable ‘cdc’. This variable is the client side of the <em>usb_cdc_interface</em>.</p>
<p><a href="#id8"><span class="problematic" id="id9">|appendix|</span></a></p>
<div class="section" id="demo-hardware-setup">
<h3>Demo Hardware Setup<a class="headerlink" href="#demo-hardware-setup" title="Permalink to this headline">¶</a></h3>
<p>To setup the demo hardware the following boards are required.</p>
<blockquote>
<div><ul>
<li><p>xCORE-USB slicekKIT (XK-SK-U16-ST)</p>
<blockquote>
<div><ul class="simple">
<li><p>xCORE-USB Core board.</p></li>
<li><p>USB A/B sliceCARD.</p></li>
<li><p>xTAG-2 debug adaptor</p></li>
<li><p>Power supply</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<div class="figure align-default" id="id4">
<a class="reference internal image-reference" href="../../../../_images/usb-slicekit.png"><img alt="../../../../_images/usb-slicekit.png" src="../../../../_images/usb-slicekit.png" style="width: 110%;"/></a>
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">XMOS xCORE-USB sliceKIT</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>The hardware should be configured as displayed above for this demo:</p>
<blockquote>
<div><ul class="simple">
<li><p>The XTAG debug adapter should be connected to the XSYS connector and
the XTAG USB should be connected to the host machine.</p></li>
<li><p>The USB sliceCARD should be connected to the U slot (J4 header) of the xCORE-USB Core
board and the other end of USB sliceCARD should be connected to host machine using a USB
cable.</p></li>
<li><p>The XLINK switch on the core board should be set on ON position.</p></li>
<li><p>The xCORE-USB core board should have the power cable connected.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="launching-the-demo-application">
<h3>Launching the demo application<a class="headerlink" href="#launching-the-demo-application" title="Permalink to this headline">¶</a></h3>
<p>Once the demo example has been built either from the command line using
xmake or via the build mechanism of xTIMEcomposer studio we can execute
the application on the xCORE-USB sliceKIT.</p>
<p>Once built there will be a <em>bin</em> directory within the project which
contains the binary for the xCORE device. The xCORE binary has a XMOS standard
.xe extension.</p>
</div>
</div>
<div class="section" id="launching-from-the-command-line">
<h2>Launching from the command line<a class="headerlink" href="#launching-from-the-command-line" title="Permalink to this headline">¶</a></h2>
<p>From the command line we use the <code class="docutils literal notranslate"><span class="pre">xrun</span></code> tool to download code to both the
xCORE devices. If we change into the bin directory of the project
we can execute the code on the xCORE microcontroller as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">xrun</span> <span class="n">app_usb_cdc_demo</span><span class="o">.</span><span class="n">xe</span>          <span class="o">&lt;--</span> <span class="n">Download</span> <span class="ow">and</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">xCORE</span> <span class="n">code</span>
</pre></div>
</div>
<p>Once this command has executed the CDC device will have enumerated as virtual serial port on
your host machine.</p>
</div>
<div class="section" id="launching-from-xtimecomposer-studio">
<h2>Launching from xTIMEcomposer Studio<a class="headerlink" href="#launching-from-xtimecomposer-studio" title="Permalink to this headline">¶</a></h2>
<p>From xTIMEcomposer Studio we use the run mechanism to download code to
xCORE device. From <em>Project Explorer</em> select the xCORE binary from the bin directory, right
click and then run as xCORE application will execute the code on the xCORE device.</p>
<p>Once this command has executed, the CDC device will have enumerated as virtual serial port on
your host machine.</p>
</div>
<div class="section" id="running-the-virtual-com-demo">
<h2>Running the Virtual COM demo<a class="headerlink" href="#running-the-virtual-com-demo" title="Permalink to this headline">¶</a></h2>
<p>To run the demo, you need to have a serial terminal software in your host machine.</p>
<p>Following sections describe in detail on how to run the demo on different OS platforms.</p>
<blockquote>
<div><ul class="simple">
<li><p>In Microsoft Windows, when the USB CDC device enumerates for the frist time it will ask
for a host driver. Use ‘Install driver from specific location’ option to point to the
‘cdc_demo.inf’ supplied along with this application note. This will load the ‘usbser.sys’
host driver for the virtual COM device.</p></li>
<li><p>Once the driver is installed, the device will be assigned with a COM port number and it
will look like the following figure in “Device Manager” (Start-&gt;Control Panel-&gt;System-&gt;Hardware-&gt;Device Manager).</p></li>
</ul>
<div class="figure align-default" id="id5">
<a class="reference internal image-reference" href="../../../../_images/com_port_windows.png"><img alt="../../../../_images/com_port_windows.png" src="../../../../_images/com_port_windows.png" style="width: 80%;"/></a>
<p class="caption"><span class="caption-number">Fig. 6 </span><span class="caption-text">Enumerated Virtual COM Port Device in Windows</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<ul class="simple">
<li><p>Use any terminal software to open the COM port with default settings. In this demo,
we have used <em>Hercules</em> as the terminal software.</p></li>
<li><p>Any keys pressed in the terminal will be looped back to the terminal via the xCORE device as
you type. Pressing enter will add a new line to the terminal output on return from the xCORE
application.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><ul class="simple">
<li><p>Under Linux, when the USB CDC device enumerates the built-in <em>ACM</em> driver will be loaded
automatically and the device will be mounted as <strong>/dev/ttyACMx</strong> where ‘x’ is a number.</p></li>
<li><p>You can execute <em>dmesg</em> command in a command prompt to determine the name on which the
device is mounted.</p></li>
<li><p>Use any serial terminal software to open the virtual serial port with default
settings. In this demo, we have used <em>Putty</em> software and the serial port is opened as shown below.</p></li>
</ul>
<div class="figure align-default" id="id6">
<a class="reference internal image-reference" href="../../../../_images/putty_conf_linux.png"><img alt="../../../../_images/putty_conf_linux.png" src="../../../../_images/putty_conf_linux.png" style="width: 50%;"/></a>
<p class="caption"><span class="caption-number">Fig. 7 </span><span class="caption-text">Opening Virtual Serial Port in Putty</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
<ul class="simple">
<li><p>Any keys pressed in the terminal will be looped back to the terminal via the xCORE device as
you type. Pressing enter will add a new line to the terminal output on return from the xCORE
application.</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><ul class="simple">
<li><p>In Mac OS X, the USB CDC device is supported by a default driver available in the OS and
the device will appear as /dev/tty.usbmodem*. You can use <em>ls /dev/tty.usbmodem*</em> command to determine the exact name of the virtual
serial device.</p></li>
<li><p>Use any serial terminal software to open the virtual serial port with default
settings. In this demo, we have used <em>CoolTerm</em> software and the serial port is opened as shown below.</p></li>
</ul>
<div class="figure align-default" id="id7">
<a class="reference internal image-reference" href="../../../../_images/coolterm_conf_mac.png"><img alt="../../../../_images/coolterm_conf_mac.png" src="../../../../_images/coolterm_conf_mac.png" style="width: 50%;"/></a>
<p class="caption"><span class="caption-number">Fig. 8 </span><span class="caption-text">Opening Virtual Serial Device in CoolTerm</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
<ul class="simple">
<li><p>Any keys pressed in the terminal will be looped back to the terminal via the xCORE device as
you type. Pressing enter will add a new line to the terminal output on return from the xCORE
application.</p></li>
</ul>
</div></blockquote>
<div class="section" id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="full-source-code-listing">
<h3>Full source code listing<a class="headerlink" href="#full-source-code-listing" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="source-code-for-main-xc">
<h2>Source code for main.xc<a class="headerlink" href="#source-code-for-main-xc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="table-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Copyright</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">2021</span> <span class="n">XMOS</span> <span class="n">LIMITED</span><span class="o">.</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">Software</span> <span class="ow">is</span> <span class="n">subject</span> <span class="n">to</span> <span class="n">the</span> <span class="n">terms</span> <span class="n">of</span> <span class="n">the</span> <span class="n">XMOS</span> <span class="n">Public</span> <span class="n">Licence</span><span class="p">:</span> <span class="n">Version</span> <span class="mf">1.</span>

<span class="c1">#include &lt;platform.h&gt;</span>
<span class="c1">#include &lt;xs1.h&gt;</span>
<span class="c1">#include "xud_device.h"</span>
<span class="c1">#include "xud_cdc.h"</span>

<span class="o">/*</span> <span class="n">USB</span> <span class="n">Endpoint</span> <span class="n">Defines</span> <span class="o">*/</span>
<span class="c1">#define XUD_EP_COUNT_OUT   2    //Includes EP0 (1 OUT EP0 + 1 BULK OUT EP)</span>
<span class="c1">#define XUD_EP_COUNT_IN    3    //Includes EP0 (1 IN EP0 + 1 INTERRUPT IN EP + 1 BULK IN EP)</span>

<span class="o">/*</span> <span class="n">Endpoint</span> <span class="nb">type</span> <span class="n">tables</span> <span class="o">-</span> <span class="n">informs</span> <span class="n">XUD</span> <span class="n">what</span> <span class="n">the</span> <span class="n">transfer</span> <span class="n">types</span> <span class="k">for</span> <span class="n">each</span> <span class="n">Endpoint</span> <span class="ow">in</span> <span class="n">use</span> <span class="ow">and</span> <span class="n">also</span>
 <span class="o">*</span> <span class="k">if</span> <span class="n">the</span> <span class="n">endpoint</span> <span class="n">wishes</span> <span class="n">to</span> <span class="n">be</span> <span class="n">informed</span> <span class="n">of</span> <span class="n">USB</span> <span class="n">bus</span> <span class="n">resets</span>
 <span class="o">*/</span>
<span class="n">XUD_EpType</span> <span class="n">epTypeTableOut</span><span class="p">[</span><span class="n">XUD_EP_COUNT_OUT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">XUD_EPTYPE_CTL</span> <span class="o">|</span> <span class="n">XUD_STATUS_ENABLE</span><span class="p">,</span> <span class="n">XUD_EPTYPE_BUL</span><span class="p">};</span>
<span class="n">XUD_EpType</span> <span class="n">epTypeTableIn</span><span class="p">[</span><span class="n">XUD_EP_COUNT_IN</span><span class="p">]</span> <span class="o">=</span>   <span class="p">{</span><span class="n">XUD_EPTYPE_CTL</span> <span class="o">|</span> <span class="n">XUD_STATUS_ENABLE</span><span class="p">,</span> <span class="n">XUD_EPTYPE_INT</span><span class="p">,</span> <span class="n">XUD_EPTYPE_BUL</span><span class="p">};</span>

<span class="o">/*</span> <span class="n">Application</span> <span class="n">task</span> <span class="o">*/</span>
<span class="n">void</span> <span class="n">app_virtual_com</span><span class="p">(</span><span class="n">client</span> <span class="n">interface</span> <span class="n">usb_cdc_interface</span> <span class="n">cdc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">char</span> <span class="n">cdc_char</span> <span class="o">=</span> <span class="n">cdc</span><span class="o">.</span><span class="n">get_char</span><span class="p">();</span>
    <span class="n">cdc</span><span class="o">.</span><span class="n">put_char</span><span class="p">(</span><span class="n">cdc_char</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cdc_char</span> <span class="o">==</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">)</span>
      <span class="n">cdc</span><span class="o">.</span><span class="n">put_char</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">Channels</span> <span class="n">to</span> <span class="n">communicate</span> <span class="k">with</span> <span class="n">USB</span> <span class="n">endpoints</span> <span class="o">*/</span>
    <span class="n">chan</span> <span class="n">c_ep_out</span><span class="p">[</span><span class="n">XUD_EP_COUNT_OUT</span><span class="p">],</span> <span class="n">c_ep_in</span><span class="p">[</span><span class="n">XUD_EP_COUNT_IN</span><span class="p">];</span>
    <span class="o">/*</span> <span class="n">Interface</span> <span class="n">to</span> <span class="n">communicate</span> <span class="k">with</span> <span class="n">USB</span> <span class="n">CDC</span> <span class="p">(</span><span class="n">Virtual</span> <span class="n">Serial</span><span class="p">)</span> <span class="o">*/</span>
    <span class="n">interface</span> <span class="n">usb_cdc_interface</span> <span class="n">cdc_data</span><span class="p">;</span>

    <span class="n">par</span>
    <span class="p">{</span>
        <span class="n">on</span> <span class="n">USB_TILE</span><span class="p">:</span> <span class="n">XUD_Main</span><span class="p">(</span><span class="n">c_ep_out</span><span class="p">,</span> <span class="n">XUD_EP_COUNT_OUT</span><span class="p">,</span> <span class="n">c_ep_in</span><span class="p">,</span> <span class="n">XUD_EP_COUNT_IN</span><span class="p">,</span>
                      <span class="n">null</span><span class="p">,</span> <span class="n">epTypeTableOut</span><span class="p">,</span> <span class="n">epTypeTableIn</span><span class="p">,</span> 
                      <span class="n">null</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">XUD_SPEED_HS</span><span class="p">,</span> <span class="n">XUD_PWR_BUS</span><span class="p">);</span>

        <span class="n">on</span> <span class="n">USB_TILE</span><span class="p">:</span> <span class="n">Endpoint0</span><span class="p">(</span><span class="n">c_ep_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_ep_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

        <span class="n">on</span> <span class="n">USB_TILE</span><span class="p">:</span> <span class="n">CdcEndpointsHandler</span><span class="p">(</span><span class="n">c_ep_in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_ep_out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_ep_in</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cdc_data</span><span class="p">);</span>

        <span class="n">on</span> <span class="n">tile</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">app_virtual_com</span><span class="p">(</span><span class="n">cdc_data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="source-code-for-xud-cdc-xc">
<h2>Source code for xud_cdc.xc<a class="headerlink" href="#source-code-for-xud-cdc-xc" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="table-wrapper"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span>// Copyright 2015-2021 XMOS LIMITED.
// This Software is subject to the terms of the XMOS Public Licence: Version 1.

#include &lt;xs1.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include "xud_cdc.h"

/* USB CDC device product defines */
#define BCD_DEVICE  0x0100
#define VENDOR_ID   0x20B1
#define PRODUCT_ID  0x0401

/* USB Sub class and protocol codes */
#define USB_CDC_ACM_SUBCLASS        0x02
#define USB_CDC_AT_COMMAND_PROTOCOL 0x01

/* CDC interface descriptor type */
#define USB_DESCTYPE_CS_INTERFACE   0x24

/* Endpoint Addresses for CDC device */
#define CDC_NOTIFICATION_EP_NUM     1
#define CDC_DATA_RX_EP_NUM          1
#define CDC_DATA_TX_EP_NUM          2

/* Data endpoint packet size */
#define MAX_EP_SIZE     512

/* CDC Communications Class requests */
#define CDC_SET_LINE_CODING         0x20
#define CDC_GET_LINE_CODING         0x21
#define CDC_SET_CONTROL_LINE_STATE  0x22
#define CDC_SEND_BREAK              0x23

/* Definition of Descriptors */
/* USB Device Descriptor */
static unsigned char devDesc[] =
{
    0x12,                  /* 0  bLength */
    USB_DESCTYPE_DEVICE,   /* 1  bdescriptorType - Device*/
    0x00,                  /* 2  bcdUSB version */
    0x02,                  /* 3  bcdUSB version */
    USB_CLASS_COMMUNICATIONS,/* 4  bDeviceClass - USB CDC Class */
    0x00,                  /* 5  bDeviceSubClass  - Specified by interface */
    0x00,                  /* 6  bDeviceProtocol  - Specified by interface */
    0x40,                  /* 7  bMaxPacketSize for EP0 - max = 64*/
    (VENDOR_ID &amp; 0xFF),    /* 8  idVendor */
    (VENDOR_ID &gt;&gt; 8),      /* 9  idVendor */
    (PRODUCT_ID &amp; 0xFF),   /* 10 idProduct */
    (PRODUCT_ID &gt;&gt; 8),     /* 11 idProduct */
    (BCD_DEVICE &amp; 0xFF),   /* 12 bcdDevice */
    (BCD_DEVICE &gt;&gt; 8),     /* 13 bcdDevice */
    0x01,                  /* 14 iManufacturer - index of string*/
    0x02,                  /* 15 iProduct  - index of string*/
    0x03,                  /* 16 iSerialNumber  - index of string*/
    0x01                   /* 17 bNumConfigurations */
};

/* USB Configuration Descriptor */
static unsigned char cfgDesc[] = {

  0x09,                       /* 0  bLength */
  USB_DESCTYPE_CONFIGURATION, /* 1  bDescriptortype - Configuration*/
  0x43, 0x00,                 /* 2  wTotalLength */
  0x02,                       /* 4  bNumInterfaces */
  0x01,                       /* 5  bConfigurationValue */
  0x04,                       /* 6  iConfiguration - index of string */
  0x80,                       /* 7  bmAttributes - Bus powered */
  0xC8,                       /* 8  bMaxPower - 400mA */

  /* CDC Communication interface */
  0x09,                       /* 0  bLength */
  USB_DESCTYPE_INTERFACE,     /* 1  bDescriptorType - Interface */
  0x00,                       /* 2  bInterfaceNumber - Interface 0 */
  0x00,                       /* 3  bAlternateSetting */
  0x01,                       /* 4  bNumEndpoints */
  USB_CLASS_COMMUNICATIONS,   /* 5  bInterfaceClass */
  USB_CDC_ACM_SUBCLASS,       /* 6  bInterfaceSubClass - Abstract Control Model */
  USB_CDC_AT_COMMAND_PROTOCOL,/* 7  bInterfaceProtocol - AT Command V.250 protocol */
  0x00,                       /* 8  iInterface - No string descriptor */

  /* Header Functional descriptor */
  0x05,                      /* 0  bLength */
  USB_DESCTYPE_CS_INTERFACE, /* 1  bDescriptortype, CS_INTERFACE */
  0x00,                      /* 2  bDescriptorsubtype, HEADER */
  0x10, 0x01,                /* 3  bcdCDC */

  /* ACM Functional descriptor */
  0x04,                      /* 0  bLength */
  USB_DESCTYPE_CS_INTERFACE, /* 1  bDescriptortype, CS_INTERFACE */
  0x02,                      /* 2  bDescriptorsubtype, ABSTRACT CONTROL MANAGEMENT */
  0x02,                      /* 3  bmCapabilities: Supports subset of ACM commands */

  /* Union Functional descriptor */
  0x05,                     /* 0  bLength */
  USB_DESCTYPE_CS_INTERFACE,/* 1  bDescriptortype, CS_INTERFACE */
  0x06,                     /* 2  bDescriptorsubtype, UNION */
  0x00,                     /* 3  bControlInterface - Interface 0 */
  0x01,                     /* 4  bSubordinateInterface0 - Interface 1 */

  /* Call Management Functional descriptor */
  0x05,                     /* 0  bLength */
  USB_DESCTYPE_CS_INTERFACE,/* 1  bDescriptortype, CS_INTERFACE */
  0x01,                     /* 2  bDescriptorsubtype, CALL MANAGEMENT */
  0x03,                     /* 3  bmCapabilities, DIY */
  0x01,                     /* 4  bDataInterface */

  /* Notification Endpoint descriptor */
  0x07,                         /* 0  bLength */
  USB_DESCTYPE_ENDPOINT,        /* 1  bDescriptorType */
  (CDC_NOTIFICATION_EP_NUM | 0x80),/* 2  bEndpointAddress */
  0x03,                         /* 3  bmAttributes */
  0x40,                         /* 4  wMaxPacketSize - Low */
  0x00,                         /* 5  wMaxPacketSize - High */
  0xFF,                         /* 6  bInterval */

  /* CDC Data interface */
  0x09,                     /* 0  bLength */
  USB_DESCTYPE_INTERFACE,   /* 1  bDescriptorType */
  0x01,                     /* 2  bInterfacecNumber */
  0x00,                     /* 3  bAlternateSetting */
  0x02,                     /* 4  bNumEndpoints */
  USB_CLASS_CDC_DATA,       /* 5  bInterfaceClass */
  0x00,                     /* 6  bInterfaceSubClass */
  0x00,                     /* 7  bInterfaceProtocol*/
  0x00,                     /* 8  iInterface - No string descriptor*/

  /* Data OUT Endpoint descriptor */
  0x07,                     /* 0  bLength */
  USB_DESCTYPE_ENDPOINT,    /* 1  bDescriptorType */
  CDC_DATA_RX_EP_NUM,       /* 2  bEndpointAddress */
  0x02,                     /* 3  bmAttributes */
  0x00,                     /* 4  wMaxPacketSize - Low */
  0x02,                     /* 5  wMaxPacketSize - High */
  0x00,                     /* 6  bInterval */

  /* Data IN Endpoint descriptor */
  0x07,                     /* 0  bLength */
  USB_DESCTYPE_ENDPOINT,    /* 1  bDescriptorType */
  (CDC_DATA_TX_EP_NUM | 0x80),/* 2  bEndpointAddress */
  0x02,                     /* 3  bmAttributes */
  0x00,                     /* 4  wMaxPacketSize - Low byte */
  0x02,                     /* 5  wMaxPacketSize - High byte */
  0x01                      /* 6  bInterval */
};

unsafe{
  /* String table - unsafe as accessed via shared memory */
  static char * unsafe stringDescriptors[]=
  {
    "\x09\x04",             /* Language ID string (US English) */
    "XMOS",                 /* iManufacturer */
    "CDC Virtual COM Port", /* iProduct */
    "0123456789"            /* iSerialNumber */
    "Config",               /* iConfiguration string */
  };
}

/* CDC Class-specific requests handler function */
XUD_Result_t ControlInterfaceClassRequests(XUD_ep ep_out, XUD_ep ep_in, USB_SetupPacket_t sp)
{
    /* Word aligned buffer */
    unsigned int buffer[32];
    unsigned length;
    XUD_Result_t result;

    static struct LineCoding {
        unsigned int baudRate;
        unsigned char charFormat;
        unsigned char parityType;
        unsigned char dataBits;
    }lineCoding;

    static struct lineState {
        unsigned char dtr;
        unsigned char rts;
    } lineState;

#if defined (DEBUG) &amp;&amp; (DEBUG == 1)
    printhexln(sp.bRequest);
#endif

    switch(sp.bRequest)
    {
        case CDC_SET_LINE_CODING:

            if((result = XUD_GetBuffer(ep_out, (buffer, unsigned char[]), length)) != XUD_RES_OKAY)
            {
                return result;
            }

            lineCoding.baudRate = buffer[0];    /* Read 32-bit baud rate value */
            lineCoding.charFormat = (buffer, unsigned char[])[4]; /* Read one byte */
            lineCoding.parityType = (buffer, unsigned char[])[5];
            lineCoding.dataBits = (buffer, unsigned char[])[6];

            result = XUD_DoSetRequestStatus(ep_in);

            #if defined (DEBUG) &amp;&amp; (DEBUG == 1)
            printf("Baud rate: %u\n", lineCoding.baudRate);
            printf("Char format: %d\n", lineCoding.charFormat);
            printf("Parity Type: %d\n", lineCoding.parityType);
            printf("Data bits: %d\n", lineCoding.dataBits);
            #endif
            return result;

            break;

        case CDC_GET_LINE_CODING:

            buffer[0] = lineCoding.baudRate;
            (buffer, unsigned char[])[4] = lineCoding.charFormat;
            (buffer, unsigned char[])[5] = lineCoding.parityType;
            (buffer, unsigned char[])[6] = lineCoding.dataBits;

            return XUD_DoGetRequest(ep_out, ep_in, (buffer, unsigned char[]), 7, sp.wLength);

            break;

        case CDC_SET_CONTROL_LINE_STATE:

            /* Data present in wValue */
            lineState.dtr = sp.wValue &amp; 0x01;
            lineState.rts = (sp.wValue &gt;&gt; 1) &amp; 0x01;

            /* Acknowledge */
            result =  XUD_DoSetRequestStatus(ep_in);

            #if defined (DEBUG) &amp;&amp; (DEBUG == 1)
            printf("DTR: %d\n", lineState.dtr);
            printf("RTS: %d\n", lineState.rts);
            #endif

            return result;

            break;

        case CDC_SEND_BREAK:
            /* Send break signal on UART (if requried) */
            // sp.wValue says the number of milliseconds to hold in BREAK condition
            return XUD_DoSetRequestStatus(ep_in);

            break;

        default:
            // Error case
            printhexln(sp.bRequest);
            break;
    }
    return XUD_RES_ERR;
}

/* Endpoint 0 handling both std USB requests and CDC class specific requests */
void Endpoint0(chanend chan_ep0_out, chanend chan_ep0_in)
{
    USB_SetupPacket_t sp;

    unsigned bmRequestType;
    XUD_BusSpeed_t usbBusSpeed;

    XUD_ep ep0_out = XUD_InitEp(chan_ep0_out);
    XUD_ep ep0_in = XUD_InitEp(chan_ep0_in);

    while(1)
    {
        /* Returns XUD_RES_OKAY on success */
        XUD_Result_t result = USB_GetSetupPacket(ep0_out, ep0_in, sp);

        if(result == XUD_RES_OKAY)
        {
            /* Set result to ERR, we expect it to get set to OKAY if a request is handled */
            result = XUD_RES_ERR;

            /* Stick bmRequest type back together for an easier parse... */
            bmRequestType = (sp.bmRequestType.Direction&lt;&lt;7) |
                            (sp.bmRequestType.Type&lt;&lt;5) |
                            (sp.bmRequestType.Recipient);

            if ((bmRequestType == USB_BMREQ_H2D_STANDARD_DEV) &amp;&amp;
                (sp.bRequest == USB_SET_ADDRESS))
            {
              // Host has set device address, value contained in sp.wValue
            }

            switch(bmRequestType)
            {
                /* Direction: Device-to-host and Host-to-device
                 * Type: Class
                 * Recipient: Interface
                 */
                case USB_BMREQ_H2D_CLASS_INT:
                case USB_BMREQ_D2H_CLASS_INT:

                    /* Inspect for CDC Communications Class interface num */
                    if(sp.wIndex == 0)
                    {
                        /* Returns  XUD_RES_OKAY if handled,
                         *          XUD_RES_ERR if not handled,
                         *          XUD_RES_RST for bus reset */
                        result = ControlInterfaceClassRequests(ep0_out, ep0_in, sp);
                    }
                    break;
            }
        } /* if ends */

        /* If we haven't handled the request about then do standard enumeration requests */
        if(result == XUD_RES_ERR )
        {
            /* Returns  XUD_RES_OKAY if handled okay,
             *          XUD_RES_ERR if request was not handled (STALLed),
             *          XUD_RES_RST for USB Reset */
            unsafe{
            result = USB_StandardRequests(ep0_out, ep0_in, devDesc,
                        sizeof(devDesc), cfgDesc, sizeof(cfgDesc),
                        null, 0, null, 0, stringDescriptors, sizeof(stringDescriptors)/sizeof(stringDescriptors[0]),
                        sp, usbBusSpeed);
             }
        }

        /* USB bus reset detected, reset EP and get new bus speed */
        if(result == XUD_RES_RST)
        {
            usbBusSpeed = XUD_ResetEndpoint(ep0_out, ep0_in);
        }
    }
}

/* Function to handle all endpoints of the CDC class excluding control endpoint0 */
void CdcEndpointsHandler(chanend c_epint_in, chanend c_epbulk_out, chanend c_epbulk_in,
                         SERVER_INTERFACE(usb_cdc_interface, cdc))
{
    static unsigned char txBuf[2][MAX_EP_SIZE];
    static unsigned char rxBuf[2][MAX_EP_SIZE];
    int readBufId = 0, writeBufId = 0;          // used to identify buffer read/write by device
    int rxLen[2] = {0, 0}, txLen = 0;
    int readIndex = 0;
    int readWaiting = 0, writeWaiting = 1;

    unsigned length;
    XUD_Result_t result;

    /* Initialize all endpoints */
    XUD_ep epint_in = XUD_InitEp(c_epint_in);
    XUD_ep epbulk_out = XUD_InitEp(c_epbulk_out);
    XUD_ep epbulk_in = XUD_InitEp(c_epbulk_in);

    /* XUD will NAK if the endpoint is not ready to communicate with XUD */

    /* TODO: Interrupt endpoint to report serial state (if required) */

    /* Just to keep compiler happy */
    epint_in = epint_in;

    XUD_SetReady_Out(epbulk_out, rxBuf[!readBufId]);

    while(1)
    {
      select
      {
        case XUD_GetData_Select(c_epbulk_out, epbulk_out, length, result):

           if(result == XUD_RES_OKAY)
           {
               /* Received some data */
               rxLen[!readBufId] = length;

               /* Check if application has completed reading the read buffer */
               if(rxLen[readBufId] == 0) {
                   /* Switch buffers */
                   readBufId = !readBufId;
                   readIndex = 0;
                   /* Make the OUT endpoint ready to receive data */
                   XUD_SetReady_Out(epbulk_out, rxBuf[!readBufId]);
               } else {
                   /* Application is still reading the read buffer
                    * Say that another buffer is also waiting to be read */
                   readWaiting = 1;
               }
           } else {
               XUD_SetReady_Out(epbulk_out, rxBuf[!readBufId]);
           }
           break;

        case XUD_SetData_Select(c_epbulk_in, epbulk_in, result):

            /* Packet sent successfully when result in XUD_RES_OKAY */
            if (0 != txLen) {
                /* Data available to send to Host */
                XUD_SetReady_In(epbulk_in, txBuf[writeBufId], txLen);
                /* Switch write buffers */
                writeBufId = !writeBufId;
                txLen = 0;
            } else {
                writeWaiting = 1;
            }

            break;

        /* Case handlers for CDC functions */
        case (0 != rxLen[readBufId]) =&gt; cdc.read(unsigned char data[], REFERENCE_PARAM(unsigned, count)) -&gt; int read_count:

            /* Some data available to read */
            if(count &lt;= rxLen[readBufId]) {
                /* Read only 'count' number of bytes */
                memcpy(data, rxBuf[readBufId]+readIndex, count);
                read_count = count;
                readIndex += count;
                rxLen[readBufId] -= count;

            } else if(count &gt; rxLen[readBufId]) {
                /* Read all bytes from buffer */
                memcpy(data, rxBuf[readBufId]+readIndex, rxLen[readBufId]);
                read_count = rxLen[readBufId];
                rxLen[readBufId] = 0;
                readIndex = 0;
            }

            if(readWaiting &amp;&amp; (rxLen[readBufId] == 0)) {
                /* Other buffer is waiting to be read; switch it for reading */
                readBufId = !readBufId;
                readIndex = readWaiting = 0;
                XUD_SetReady_Out(epbulk_out, rxBuf[!readBufId]);
            }
            break;

        case (0 != rxLen[readBufId]) =&gt; cdc.get_char() -&gt; unsigned char data:
            /* Read one byte of data */
            data = rxBuf[readBufId][readIndex++];
            rxLen[readBufId]--;

            if(readWaiting &amp;&amp; (rxLen[readBufId] == 0)) {
                /* Other buffer is waiting to be read; switch it for reading */
                readBufId = !readBufId;
                readIndex = readWaiting = 0;
                XUD_SetReady_Out(epbulk_out, rxBuf[!readBufId]);
            }
            break;

        case (MAX_EP_SIZE != txLen) =&gt; cdc.put_char(char byte):
            txBuf[writeBufId][txLen] = byte;
            txLen++;

            /* Check if we can initiate transfer */
            if(writeWaiting) {
                XUD_SetReady_In(epbulk_in, txBuf[writeBufId], txLen);
                writeBufId = !writeBufId;
                txLen = 0;
                writeWaiting = 0;
            }
            break;

        case (MAX_EP_SIZE != txLen) =&gt; cdc.write(unsigned char data[], REFERENCE_PARAM(unsigned, length)) -&gt; int write_count:

            if((txLen + length) &lt;= MAX_EP_SIZE) {
                /* Enough space available to hold all data */
                write_count = length;
            } else {
                /* Only partial data can be put into buffer */
                write_count = MAX_EP_SIZE - txLen;
            }
            memcpy(txBuf[writeBufId] + txLen, data, write_count);
            txLen += write_count;

            /* Check if we can initiate transfer */
            if(writeWaiting) {
                XUD_SetReady_In(epbulk_in, txBuf[writeBufId], txLen);
                writeBufId = !writeBufId;
                txLen = 0;
                writeWaiting = 0;
            }
            break;

        case cdc.available_bytes() -&gt; int count:
            count = rxLen[readBufId];
            break;

        case cdc.flush_buffer():

            /* Flush everything */
            rxLen[readBufId] = 0;
            readIndex = 0;

            if(readWaiting) {
                /* Other buffer is ready to be read, flush that too */
                readBufId = !readBufId;
                rxLen[readBufId] = 0;
                readWaiting = 0;
                XUD_SetReady_Out(epbulk_out, rxBuf[!readBufId]);
            }
            break;
      }
    }

}
</pre></div>
</td></tr></table></div></div>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../../AN00125_mass_storage_class/doc/rst/AN00125.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Mass Storage class</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../../../doc/usb_class_examples.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">USB Class examples</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, XMOS Ltd
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../../../../_sources/examples/AN00124_CDC_VCOM_class/doc/rst/AN00124.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">CDC VCOM class</a><ul>
<li><a class="reference internal" href="#block-diagram">Block diagram</a><ul>
<li><a class="reference internal" href="#usb-cdc-class-application-note">USB CDC Class application note</a></li>
</ul>
</li>
<li><a class="reference internal" href="#makefile-additions-for-this-example">Makefile additions for this example</a></li>
<li><a class="reference internal" href="#source-code-files">Source code files</a></li>
<li><a class="reference internal" href="#declaring-resource-and-setting-up-the-usb-components">Declaring resource and setting up the USB components</a></li>
<li><a class="reference internal" href="#the-application-main-function">The application main() function</a></li>
<li><a class="reference internal" href="#configuring-the-usb-device-id">Configuring the USB Device ID</a></li>
<li><a class="reference internal" href="#usb-descriptors">USB Descriptors</a></li>
<li><a class="reference internal" href="#usb-standard-and-class-specific-requests">USB Standard and Class-Specific requests</a></li>
<li><a class="reference internal" href="#data-handling">Data handling</a></li>
<li><a class="reference internal" href="#application-interface">Application interface</a><ul>
<li><a class="reference internal" href="#demo-hardware-setup">Demo Hardware Setup</a></li>
<li><a class="reference internal" href="#launching-the-demo-application">Launching the demo application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#launching-from-the-command-line">Launching from the command line</a></li>
<li><a class="reference internal" href="#launching-from-xtimecomposer-studio">Launching from xTIMEcomposer Studio</a></li>
<li><a class="reference internal" href="#running-the-virtual-com-demo">Running the Virtual COM demo</a><ul>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#full-source-code-listing">Full source code listing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#source-code-for-main-xc">Source code for main.xc</a></li>
<li><a class="reference internal" href="#source-code-for-xud-cdc-xc">Source code for xud_cdc.xc</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/tabs.js"></script>
    <script src="../../../../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></body>
</html>